<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>HA-LB-FO/lb2</title>
    <meta name="author" content="PCo-2016/2019">
    <meta name="description" content="SISR">
    <meta name="highlight" content="true">
    <meta name="pasnumero" content="false">
    <link rel="icon" href="http://cp.cosson.free.fr/pco-css-js/favicon.ico">
    <link rel="stylesheet" type="text/css" href="http://cp.cosson.free.fr/pco-css-js/cours.css">
    <script language="javascript" src="http://cp.cosson.free.fr/pco-css-js/dev_red_hx.js"></script>
	<style>
		i {color: mediumaquamarine;}
		pre {tab-size: 4;-moz-tab-size: 4;}
		b .hljs-comment {color: red;}
	</style>
  </head>
  <body>
      
        <p>
          <img class="fixe" src="HA-LB-FO.png" alt="schéma HA-LB-FO">
        </p>


    <h1><i>$ nano</i> /etc/hostname</h1>

    <pre><code class="bash">lb2
</code></pre>

    <h1><i>$ nano</i> /etc/hosts</h1>

    <pre><code class="bash">127.0.0.1	localhost
127.0.1.1	lb2
192.168.56.11	lb1
192.168.56.12	lb2
192.168.200.11	web1
192.168.200.12	web2
192.168.200.13	web3

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre>

    <h1><i>$ bash</i> install_ipvsadm_heartbeat.sh</h1>

    <pre><code class="bash">#!/bin/sh
apt update
apt -y install ipvsadm
apt -y install heartbeat
# activation routage
sed -i &#x27;s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/&#x27; /etc/sysctl.conf
	</code></pre>

    <h1><i>$ nano</i> /etc/ipvsadm.rules</h1>

    <pre><code class="bash">ipvsadm -A -t 192.168.56.10:80 -s rr
ipvsadm -a -t 192.168.56.10:80 -r 192.168.200.11:80 -m
ipvsadm -a -t 192.168.56.10:80 -r 192.168.200.12:80 -m
ipvsadm -a -t 192.168.56.10:80 -r 192.168.200.13:80 -m
</code></pre>

    <h1><i>$ nano</i> /etc/default/ipvsadm</h1>

    <pre><code class="bash"># ipvsadm
# if you want to start ipvsadm on boot set this to true
AUTO=&quot;true&quot;
# daemon method (none|master|backup)
DAEMON=&quot;master&quot;
# use interface (eth0,eth1...)
IFACE=&quot;enp0s3&quot;	
</code></pre>

    <h1><i>$ nano</i> /etc/ha.d/ha.cf</h1>

    <pre><code class="bash">bcast enp0s3
deadtime 5
keepalive 1
node lb1 lb2
</code></pre>

    <h1><i>$ nano</i> /etc/ha.d/haresources</h1>

    <pre><code class="bash">#adresses virtuelles (et flottantes)
lb1	IPaddr::192.168.56.10	ipvsadm
lb1	IPaddr::192.168.200.254
</code></pre>

    <h1><i>$ nano</i> /etc/ha.d/authkeys</h1>

    <pre><code class="bash">auth 1
1 md5 motdepasse
</code></pre>

    <h1><i>$ bash</i> chmod_authkeys.sh</h1>

    <pre><code class="bash">#!/bin/sh
chmod 600 /etc/ha.d/authkeys
</code></pre>

    <h1><i>$ nano</i> /etc/network/interfaces</h1>

    <pre><code class="bash"># localhost
auto lo
iface lo inet loopback

# réseau privé hôte &gt; 192.168.56.0/24
allow-hotplug enp0s3
iface enp0s3 inet static
	address 192.168.56.12/24

# réseau interne &#x27;R200&#x27; &gt; 192.168.200.0/24
allow-hotplug enp0s8
iface enp0s8 inet static
	address 192.168.200.252/24

# <b><strong>✋</strong> valider la configuration "Réseau" sous VirtualBox, puis redémarrer…</b>
</code></pre>

    <h1><i>$ bash</i> ipvsadm_reconfig.sh</h1>

    <pre><code class="bash">#!/bin/sh
dpkg-reconfigure ipvsadm
systemctl restart ipvsadm.service
systemctl status ipvsadm.service</code></pre>

    </body>
</html>